name: CI/CD â€“ Build, Push to ECR, Deploy to EC2

# -------------------------------------------------------------
# Trigger workflow WHEN a Pull Request into main is CLOSED
# AND is actually MERGED.
# Docs: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request
# -------------------------------------------------------------
on:
  pull_request:
    branches:
      - main
    types:
      - closed

jobs:
  # ============================================================
  # JOB 1: BUILD AND PUSH IMAGE TO ECR
  # ============================================================
  build-and-push:
    name: Build & Push Docker Image to ECR
    runs-on: ubuntu-latest

    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true

    steps:
      # ---------------------------------------------------------
      # Step 1: Checkout source code
      # Docs: https://github.com/actions/checkout
      # ---------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # ---------------------------------------------------------
      # Step 2: Configure AWS credentials
      # Docs: https://github.com/aws-actions/configure-aws-credentials
      # ---------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ---------------------------------------------------------
      # Step 3: Login to ECR
      # Docs: https://github.com/aws-actions/amazon-ecr-login
      # ---------------------------------------------------------
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ---------------------------------------------------------
      # Step 4: Build and push Docker image to ECR
      # ---------------------------------------------------------
      - name: Build, tag, and push Docker image
        env:
          ECR_REGISTRY: ${{ secrets.AWS_ECR_REGISTRY }}
          ECR_REPOSITORY: ${{ secrets.AWS_ECR_REPOSITORY }}
        run: |
          echo "Building Docker image..."
          docker build -f docker/Dockerfile.s3 -t $ECR_REPOSITORY .

          echo "Tagging image..."
          docker tag $ECR_REPOSITORY:latest $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "Pushing image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest


  # ============================================================
  # JOB 2: DEPLOY TO EC2 USING SSH
  # ============================================================
  deploy-to-ec2:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest

    # Only run if PR was merged
    if: github.event.pull_request.merged == true

    steps:
      # ---------------------------------------------------------
      # Connect to EC2 with SSH and deploy new Docker image
      # Docs: https://github.com/appleboy/ssh-action
      # ---------------------------------------------------------
      - name: SSH into EC2 and deploy container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ubuntu               # default for Amazon Linux
          key: ${{ secrets.EC2_SSH_KEY }}  # private SSH key
          port: 22
          script: |
            echo "Logging into ECR from EC2 (IAM role handles auth)..."
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} \
              | sudo docker login --username AWS --password-stdin ${{ secrets.AWS_ECR_REGISTRY }}

            echo "Stopping old container..."
            sudo docker stop mlapi || true
            sudo docker rm mlapi || true

            echo "Pulling latest image..."
            sudo docker pull ${{ secrets.AWS_ECR_REGISTRY }}/${{ secrets.AWS_ECR_REPOSITORY }}:latest

            echo "Starting new container..."
            sudo docker run -d --name mlapi -p 80:80 \
              ${{ secrets.AWS_ECR_REGISTRY }}/${{ secrets.AWS_ECR_REPOSITORY }}:latest

            echo "Deployment complete!"